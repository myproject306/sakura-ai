<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel â€” Sakura AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .admin-layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; margin-top: 70px; }
    .admin-sidebar {
      background: var(--dark); color: white; padding: 28px 16px;
      position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto;
    }
    .admin-sidebar h5 { font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 20px 0 8px 8px; }
    .admin-nav-link {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border-radius: var(--radius-sm); font-size: 13px; font-weight: 500;
      color: rgba(255,255,255,0.6); transition: var(--transition); cursor: pointer;
      margin-bottom: 2px; border: none; background: none; width: 100%; text-align: left; font-family: inherit;
    }
    .admin-nav-link:hover, .admin-nav-link.active { background: rgba(247,183,200,0.15); color: var(--primary); }
    .admin-nav-link .nav-icon { font-size: 16px; width: 20px; text-align: center; }
    .admin-main { background: var(--accent); padding: 32px; overflow-y: auto; }
    .admin-panel { display: none; }
    .admin-panel.active { display: block; }
    .admin-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; }
    .admin-header h2 { font-size: 22px; font-weight: 800; color: var(--dark); }
    /* Metric cards */
    .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
    .metric-card {
      background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md);
      padding: 20px; transition: var(--transition);
    }
    .metric-card:hover { box-shadow: var(--shadow-sm); transform: translateY(-2px); }
    .metric-icon { font-size: 24px; margin-bottom: 10px; }
    .metric-value { font-size: 30px; font-weight: 800; color: var(--dark); line-height: 1; margin-bottom: 4px; }
    .metric-label { font-size: 12px; color: var(--light-gray); }
    .metric-change { font-size: 11px; font-weight: 600; margin-top: 6px; }
    .metric-change.up { color: #22C55E; }
    .metric-change.down { color: #EF4444; }
    /* Tables */
    .admin-table-wrap { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; margin-bottom: 24px; }
    .admin-table-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
    .admin-table-header h3 { font-size: 15px; font-weight: 700; color: var(--dark); }
    table.admin-table { width: 100%; border-collapse: collapse; }
    table.admin-table th { background: var(--accent); padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
    table.admin-table td { padding: 12px 16px; font-size: 13px; color: var(--dark); border-bottom: 1px solid var(--border); }
    table.admin-table tr:last-child td { border-bottom: none; }
    table.admin-table tr:hover td { background: var(--accent); }
    .status-badge {
      display: inline-block; padding: 3px 10px; border-radius: var(--radius-full);
      font-size: 11px; font-weight: 700;
    }
    .status-active   { background: #DCFCE7; color: #166534; }
    .status-trialing { background: #DBEAFE; color: #1E40AF; }
    .status-canceled { background: #FEE2E2; color: #991B1B; }
    .status-free     { background: var(--secondary); color: var(--primary-deep); }
    .status-past_due { background: #FEF3C7; color: #92400E; }
    .plan-badge-sm {
      display: inline-block; padding: 2px 8px; border-radius: var(--radius-full);
      font-size: 11px; font-weight: 700;
    }
    .plan-starter { background: #E8F5E9; color: #2E7D32; }
    .plan-pro     { background: var(--secondary); color: var(--primary-deep); }
    .plan-team    { background: #EDE9FE; color: #5B21B6; }
    .plan-free    { background: var(--accent); color: var(--gray); }
    /* Search & filter */
    .table-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .admin-search {
      padding: 8px 14px; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
      font-size: 13px; font-family: inherit; outline: none; transition: var(--transition); min-width: 200px;
    }
    .admin-search:focus { border-color: var(--primary); }
    .admin-select {
      padding: 8px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
      font-size: 13px; font-family: inherit; outline: none; background: var(--white);
    }
    .btn-admin { padding: 8px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; transition: var(--transition); font-family: inherit; border: none; }
    .btn-admin.primary { background: var(--gradient-pink); color: white; }
    .btn-admin.outline { background: transparent; border: 1.5px solid var(--border); color: var(--gray); }
    .btn-admin.danger  { background: #FEE2E2; color: #DC2626; border: 1px solid #FECACA; }
    .btn-admin:hover { transform: translateY(-1px); }
    /* Log severity */
    .log-error    { color: #DC2626; }
    .log-warn     { color: #D97706; }
    .log-info     { color: #2563EB; }
    .log-critical { color: #7C3AED; font-weight: 700; }
    /* Revenue card */
    .revenue-card {
      background: var(--gradient-pink); border-radius: var(--radius-lg);
      padding: 28px; color: white; margin-bottom: 24px;
    }
    .revenue-card h3 { font-size: 14px; opacity: 0.85; margin-bottom: 8px; }
    .revenue-value { font-size: 40px; font-weight: 800; line-height: 1; }
    .revenue-sub { font-size: 13px; opacity: 0.75; margin-top: 6px; }
    /* Loading */
    .admin-loading { text-align: center; padding: 40px; color: var(--light-gray); font-size: 14px; }
    @media (max-width: 900px) {
      .admin-layout { grid-template-columns: 1fr; }
      .admin-sidebar { display: none; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#e8547a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Sakura AI" />
  <link rel="apple-touch-icon" href="icons/icon.svg" />
</head>
<body>

<nav class="navbar">
  <div class="container">
    <a href="index.html" class="logo">
      <div class="logo-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="8.5" cy="17" r="4" fill="white"/><circle cx="15.5" cy="17" r="4" fill="white"/><path d="M8.5 13C8.5 10 11 7.5 12 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M15.5 13C15.5 10 13 7.5 12 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M12 5C12.5 3.5 14 2.5 15.5 3" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
      Sakura <span class="brand">AI</span>
    </a>
    <div class="nav-actions">
      <span style="font-size:12px;font-weight:700;color:var(--primary-deep);background:var(--secondary);padding:4px 12px;border-radius:var(--radius-full);">ğŸ” Admin</span>
      <a href="dashboard.html" class="btn-ghost" style="text-decoration:none;">Dashboard</a>
    </div>
  </div>
</nav>

<div class="admin-layout">

  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div style="padding:0 8px 20px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:8px;">
      <div style="font-size:16px;font-weight:800;color:white;">Admin Panel</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:2px;" id="adminEmail">Loading...</div>
    </div>
    <h5>Overview</h5>
    <button class="admin-nav-link active" onclick="showPanel('dashboard')"><span class="nav-icon">ğŸ“Š</span> Dashboard</button>
    <button class="admin-nav-link" onclick="showPanel('metrics')"><span class="nav-icon">ğŸ’°</span> Revenue & Metrics</button>
    <h5>Management</h5>
    <button class="admin-nav-link" onclick="showPanel('users')"><span class="nav-icon">ğŸ‘¥</span> Users</button>
    <button class="admin-nav-link" onclick="showPanel('usage')"><span class="nav-icon">ğŸ“ˆ</span> Usage Analytics</button>
    <button class="admin-nav-link" onclick="showPanel('templates')"><span class="nav-icon">ğŸ“š</span> Templates</button>
    <h5>System</h5>
    <button class="admin-nav-link" onclick="showPanel('logs')"><span class="nav-icon">ğŸ”</span> Error Logs</button>
    <button class="admin-nav-link" onclick="showPanel('queue')"><span class="nav-icon">âš™ï¸</span> Queue Status</button>
  </aside>

  <!-- Main -->
  <main class="admin-main">

    <!-- â”€â”€ Dashboard Panel â”€â”€ -->
    <div class="admin-panel active" id="panel-dashboard">
      <div class="admin-header">
        <h2>ğŸ“Š Dashboard Overview</h2>
        <button class="btn-admin primary" onclick="loadDashboard()"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      <div class="metrics-grid" id="dashMetrics">
        <div class="admin-loading">Loading metrics...</div>
      </div>
      <div id="dashPlanBreakdown"></div>
    </div>

    <!-- â”€â”€ Revenue Panel â”€â”€ -->
    <div class="admin-panel" id="panel-metrics">
      <div class="admin-header"><h2>ğŸ’° Revenue & Metrics</h2></div>
      <div id="revenueContent"><div class="admin-loading">Loading revenue data...</div></div>
    </div>

    <!-- â”€â”€ Users Panel â”€â”€ -->
    <div class="admin-panel" id="panel-users">
      <div class="admin-header">
        <h2>ğŸ‘¥ Users</h2>
        <div class="table-controls">
          <input type="text" class="admin-search" id="userSearch" placeholder="Search by email or name..." oninput="debounceLoadUsers()" />
          <select class="admin-select" id="userPlanFilter" onchange="loadUsers()">
            <option value="">All Plans</option>
            <option value="free">Free</option>
            <option value="starter">Starter</option>
            <option value="pro">Pro</option>
            <option value="team">Team</option>
          </select>
          <select class="admin-select" id="userStatusFilter" onchange="loadUsers()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="trialing">Trialing</option>
            <option value="canceled">Canceled</option>
            <option value="past_due">Past Due</option>
          </select>
        </div>
      </div>
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th><th>Plan</th><th>Status</th><th>Credits</th><th>Projects</th><th>Joined</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr><td colspan="7" class="admin-loading">Loading users...</td></tr>
          </tbody>
        </table>
      </div>
      <div id="usersPagination" style="display:flex;gap:8px;justify-content:center;margin-top:16px;"></div>
    </div>

    <!-- â”€â”€ Usage Panel â”€â”€ -->
    <div class="admin-panel" id="panel-usage">
      <div class="admin-header">
        <h2>ğŸ“ˆ Usage Analytics</h2>
        <select class="admin-select" id="usageDays" onchange="loadUsage()">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
      <div id="usageContent"><div class="admin-loading">Loading usage data...</div></div>
    </div>

    <!-- â”€â”€ Templates Panel â”€â”€ -->
    <div class="admin-panel" id="panel-templates">
      <div class="admin-header">
        <h2>ğŸ“š Templates</h2>
        <button class="btn-admin primary" onclick="showAddTemplate()"><i class="fas fa-plus"></i> Add Template</button>
      </div>
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead><tr><th>Template</th><th>Category</th><th>Uses</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="templatesTableBody"><tr><td colspan="5" class="admin-loading">Loading templates...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Logs Panel â”€â”€ -->
    <div class="admin-panel" id="panel-logs">
      <div class="admin-header">
        <h2>ğŸ” Error Logs</h2>
        <select class="admin-select" id="logSeverity" onchange="loadLogs()">
          <option value="">All Severity</option>
          <option value="error">Error</option>
          <option value="warn">Warning</option>
          <option value="info">Info</option>
          <option value="critical">Critical</option>
        </select>
      </div>
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead><tr><th>Time</th><th>Severity</th><th>Tool</th><th>Error</th><th>User</th></tr></thead>
          <tbody id="logsTableBody"><tr><td colspan="5" class="admin-loading">Loading logs...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Queue Panel â”€â”€ -->
    <div class="admin-panel" id="panel-queue">
      <div class="admin-header">
        <h2>âš™ï¸ Queue Status</h2>
        <button class="btn-admin primary" onclick="loadQueue()"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      <div id="queueContent"><div class="admin-loading">Loading queue data...</div></div>
    </div>

  </main>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('ğŸŒ¸ SW registered'))
        .catch(err => console.warn('SW registration failed:', err));
    });
  }
</script>
<script src="config.js"></script>
<script src="script.js"></script>
<script>
  const API_BASE = SAKURA_CONFIG.API_BASE;

  const token = localStorage.getItem('sakura_token');
  let usersPage = 1;
  let userSearchTimeout;

  // â”€â”€ Auth check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function init() {
    if (!token) { window.location.href = 'auth.html'; return; }
    try {
      const res  = await fetch(`${API_BASE}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (!res.ok || data.user?.role !== 'admin') {
        alert('Admin access required.');
        window.location.href = 'dashboard.html';
        return;
      }
      document.getElementById('adminEmail').textContent = data.user.email;
      loadDashboard();
    } catch (err) {
      window.location.href = 'auth.html';
    }
  })();

  // â”€â”€ Panel switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showPanel(name) {
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
    document.getElementById(`panel-${name}`).classList.add('active');
    event.currentTarget.classList.add('active');

    const loaders = { users: loadUsers, usage: loadUsage, logs: loadLogs, templates: loadTemplates, metrics: loadMetrics, queue: loadQueue };
    if (loaders[name]) loaders[name]();
  }

  // â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDashboard() {
    try {
      const res  = await fetch(`${API_BASE}/admin/dashboard`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      document.getElementById('dashMetrics').innerHTML = `
        <div class="metric-card"><div class="metric-icon">ğŸ‘¥</div><div class="metric-value">${data.users.total.toLocaleString()}</div><div class="metric-label">Total Users</div><div class="metric-change up">+${data.users.newToday} today</div></div>
        <div class="metric-card"><div class="metric-icon">ğŸ’³</div><div class="metric-value">${data.users.activeSubscriptions.toLocaleString()}</div><div class="metric-label">Active Subscriptions</div><div class="metric-change up">+${data.users.newThisMonth} this month</div></div>
        <div class="metric-card"><div class="metric-icon">ğŸ¤–</div><div class="metric-value">${data.content.totalGenerations.toLocaleString()}</div><div class="metric-label">AI Generations</div></div>
        <div class="metric-card"><div class="metric-icon">âš ï¸</div><div class="metric-value">${data.errors.todayCount}</div><div class="metric-label">Errors Today</div>${data.errors.todayCount > 0 ? '<div class="metric-change down">Needs attention</div>' : '<div class="metric-change up">All clear</div>'}</div>
      `;

      const planColors = { free: 'plan-free', starter: 'plan-starter', pro: 'plan-pro', team: 'plan-team' };
      const planHtml = data.planBreakdown.map(p =>
        `<span class="plan-badge-sm ${planColors[p.plan] || 'plan-free'}" style="margin-right:8px;font-size:13px;padding:4px 12px;">${p.plan}: ${p.count}</span>`
      ).join('');
      document.getElementById('dashPlanBreakdown').innerHTML = `
        <div style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;">
          <h3 style="font-size:14px;font-weight:700;margin-bottom:14px;">Plan Distribution</h3>
          ${planHtml}
        </div>`;
    } catch (err) {
      document.getElementById('dashMetrics').innerHTML = '<div class="admin-loading">Failed to load metrics</div>';
    }
  }

  // â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsers() {
    const search = document.getElementById('userSearch').value;
    const plan   = document.getElementById('userPlanFilter').value;
    const status = document.getElementById('userStatusFilter').value;
    const params = new URLSearchParams({ page: usersPage, limit: 25 });
    if (search) params.set('search', search);
    if (plan)   params.set('plan', plan);
    if (status) params.set('status', status);

    try {
      const res  = await fetch(`${API_BASE}/admin/users?${params}`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      const planClass = { free: 'plan-free', starter: 'plan-starter', pro: 'plan-pro', team: 'plan-team' };
      const statusClass = { active: 'status-active', trialing: 'status-trialing', canceled: 'status-canceled', past_due: 'status-past_due' };

      document.getElementById('usersTableBody').innerHTML = data.users.map(u => `
        <tr>
          <td><div style="font-weight:600;">${u.name || u.email}</div><div style="font-size:11px;color:var(--light-gray);">${u.email}</div></td>
          <td><span class="plan-badge-sm ${planClass[u.plan] || 'plan-free'}">${u.plan}</span></td>
          <td>${u.subscriptionStatus ? `<span class="status-badge ${statusClass[u.subscriptionStatus] || ''}">${u.subscriptionStatus}</span>` : '<span class="status-badge status-free">free</span>'}</td>
          <td>${u.credits}</td>
          <td>${u._count?.projects || 0}</td>
          <td>${new Date(u.createdAt).toLocaleDateString()}</td>
          <td>
            <button class="btn-admin outline" style="padding:4px 10px;font-size:11px;" onclick="editUser('${u.id}', '${u.plan}', '${u.role}', ${u.isActive})">Edit</button>
            <button class="btn-admin danger" style="padding:4px 10px;font-size:11px;margin-left:4px;" onclick="deleteUser('${u.id}', '${u.email}')">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--light-gray);padding:24px;">No users found</td></tr>';

      // Pagination
      const pages = data.pagination.totalPages;
      let paginationHtml = '';
      for (let i = 1; i <= Math.min(pages, 10); i++) {
        paginationHtml += `<button class="btn-admin ${i === usersPage ? 'primary' : 'outline'}" onclick="usersPage=${i};loadUsers()">${i}</button>`;
      }
      document.getElementById('usersPagination').innerHTML = paginationHtml;
    } catch (err) {
      document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" class="admin-loading">Failed to load users</td></tr>';
    }
  }

  function debounceLoadUsers() {
    clearTimeout(userSearchTimeout);
    userSearchTimeout = setTimeout(loadUsers, 400);
  }

  async function editUser(id, currentPlan, currentRole, isActive) {
    const plan = prompt(`Change plan for user (current: ${currentPlan}):\nOptions: free, starter, pro, team`, currentPlan);
    if (!plan) return;
    try {
      const res = await fetch(`${API_BASE}/admin/users/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ plan }),
      });
      if (res.ok) { showToast('âœ… User updated'); loadUsers(); }
      else showToast('âŒ Update failed');
    } catch { showToast('âŒ Error updating user'); }
  }

  async function deleteUser(id, email) {
    if (!confirm(`Delete user ${email}? This cannot be undone.`)) return;
    try {
      const res = await fetch(`${API_BASE}/admin/users/${id}`, {
        method: 'DELETE', headers: { Authorization: `Bearer ${token}` },
      });
      if (res.ok) { showToast('âœ… User deleted'); loadUsers(); }
      else showToast('âŒ Delete failed');
    } catch { showToast('âŒ Error deleting user'); }
  }

  // â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsage() {
    const days = document.getElementById('usageDays')?.value || 30;
    try {
      const res  = await fetch(`${API_BASE}/admin/usage?days=${days}`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      document.getElementById('usageContent').innerHTML = `
        <div class="metrics-grid" style="margin-bottom:24px;">
          <div class="metric-card"><div class="metric-icon">ğŸ”¢</div><div class="metric-value">${data.totals.requests.toLocaleString()}</div><div class="metric-label">Total Requests</div></div>
          <div class="metric-card"><div class="metric-icon">ğŸª™</div><div class="metric-value">${(data.totals.tokensUsed / 1000).toFixed(1)}K</div><div class="metric-label">Tokens Used</div></div>
          <div class="metric-card"><div class="metric-icon">â­</div><div class="metric-value">${data.totals.creditsUsed.toLocaleString()}</div><div class="metric-label">Credits Used</div></div>
        </div>
        <div class="admin-table-wrap">
          <div class="admin-table-header"><h3>Top Tools (${data.period})</h3></div>
          <table class="admin-table">
            <thead><tr><th>Tool</th><th>Category</th><th>Uses</th><th>Tokens</th></tr></thead>
            <tbody>${data.byTool.map(t => `<tr><td>${t.toolName}</td><td>${t.category || 'â€”'}</td><td>${t.uses.toLocaleString()}</td><td>${(t.tokens/1000).toFixed(1)}K</td></tr>`).join('')}</tbody>
          </table>
        </div>`;
    } catch (err) {
      document.getElementById('usageContent').innerHTML = '<div class="admin-loading">Failed to load usage data</div>';
    }
  }

  // â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadLogs() {
    const severity = document.getElementById('logSeverity')?.value || '';
    try {
      const res  = await fetch(`${API_BASE}/admin/logs?severity=${severity}&limit=50`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      document.getElementById('logsTableBody').innerHTML = data.logs.map(l => `
        <tr>
          <td style="white-space:nowrap;">${new Date(l.createdAt).toLocaleString()}</td>
          <td><span class="log-${l.severity}">${l.severity.toUpperCase()}</span></td>
          <td>${l.toolName || 'â€”'}</td>
          <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.error}">${l.error}</td>
          <td>${l.userId ? l.userId.substring(0, 8) + '...' : 'â€”'}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--light-gray);padding:24px;">No logs found</td></tr>';
    } catch (err) {
      document.getElementById('logsTableBody').innerHTML = '<tr><td colspan="5" class="admin-loading">Failed to load logs</td></tr>';
    }
  }

  // â”€â”€ Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadTemplates() {
    try {
      const res  = await fetch(`${API_BASE}/admin/templates`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      document.getElementById('templatesTableBody').innerHTML = data.templates.map(t => `
        <tr>
          <td><span style="font-size:18px;margin-right:8px;">${t.emoji}</span>${t.title}</td>
          <td>${t.category}</td>
          <td>${t.uses.toLocaleString()}</td>
          <td><span class="status-badge ${t.isActive ? 'status-active' : 'status-canceled'}">${t.isActive ? 'Active' : 'Inactive'}</span></td>
          <td>
            <button class="btn-admin danger" style="padding:4px 10px;font-size:11px;" onclick="deleteTemplate('${t.id}')">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--light-gray);padding:24px;">No templates found</td></tr>';
    } catch (err) {
      document.getElementById('templatesTableBody').innerHTML = '<tr><td colspan="5" class="admin-loading">Failed to load templates</td></tr>';
    }
  }

  async function deleteTemplate(id) {
    if (!confirm('Delete this template?')) return;
    try {
      const res = await fetch(`${API_BASE}/admin/templates/${id}`, {
        method: 'DELETE', headers: { Authorization: `Bearer ${token}` },
      });
      if (res.ok) { showToast('âœ… Template deleted'); loadTemplates(); }
      else showToast('âŒ Delete failed');
    } catch { showToast('âŒ Error'); }
  }

  function showAddTemplate() {
    const title    = prompt('Template title:');
    if (!title) return;
    const category = prompt('Category (writing/code/business/study/image/audio/data):');
    const emoji    = prompt('Emoji:') || 'ğŸ“';
    const desc     = prompt('Description:');
    const promptTxt = prompt('Prompt template:');
    if (!category || !desc || !promptTxt) return;

    fetch(`${API_BASE}/admin/templates`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ title, category, emoji, description: desc, prompt: promptTxt }),
    }).then(r => r.json()).then(d => {
      if (d.template) { showToast('âœ… Template created'); loadTemplates(); }
      else showToast('âŒ Failed to create template');
    });
  }

  // â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMetrics() {
    try {
      const res  = await fetch(`${API_BASE}/admin/metrics`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      document.getElementById('revenueContent').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
          <div class="revenue-card">
            <h3>Monthly Recurring Revenue</h3>
            <div class="revenue-value">$${data.revenue.mrr.toFixed(2)}</div>
            <div class="revenue-sub">MRR from active subscriptions</div>
          </div>
          <div class="revenue-card" style="background:linear-gradient(145deg,#7C3AED,#5B21B6);">
            <h3>Annual Recurring Revenue</h3>
            <div class="revenue-value">$${data.revenue.arr.toFixed(2)}</div>
            <div class="revenue-sub">ARR projection</div>
          </div>
        </div>
        <div style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;">
          <h3 style="font-size:15px;font-weight:700;margin-bottom:16px;">Queue Status</h3>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
            <div class="metric-card"><div class="metric-icon">â³</div><div class="metric-value">${data.queue.waiting || 0}</div><div class="metric-label">Waiting</div></div>
            <div class="metric-card"><div class="metric-icon">âš¡</div><div class="metric-value">${data.queue.active || 0}</div><div class="metric-label">Active</div></div>
            <div class="metric-card"><div class="metric-icon">âœ…</div><div class="metric-value">${data.queue.completed || 0}</div><div class="metric-label">Completed</div></div>
            <div class="metric-card"><div class="metric-icon">âŒ</div><div class="metric-value">${data.queue.failed || 0}</div><div class="metric-label">Failed</div></div>
          </div>
          <div style="margin-top:12px;font-size:12px;color:var(--light-gray);">Mode: ${data.queue.mode || 'in-memory'}</div>
        </div>`;
    } catch (err) {
      document.getElementById('revenueContent').innerHTML = '<div class="admin-loading">Failed to load metrics</div>';
    }
  }

  // â”€â”€ Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadQueue() {
    try {
      const res  = await fetch(`${API_BASE}/admin/metrics`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      document.getElementById('queueContent').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
          <div class="metric-card"><div class="metric-icon">â³</div><div class="metric-value">${data.queue.waiting || 0}</div><div class="metric-label">Waiting</div></div>
          <div class="metric-card"><div class="metric-icon">âš¡</div><div class="metric-value">${data.queue.active || 0}</div><div class="metric-label">Active</div></div>
          <div class="metric-card"><div class="metric-icon">âœ…</div><div class="metric-value">${data.queue.completed || 0}</div><div class="metric-label">Completed</div></div>
          <div class="metric-card"><div class="metric-icon">âŒ</div><div class="metric-value">${data.queue.failed || 0}</div><div class="metric-label">Failed</div></div>
        </div>
        <div style="margin-top:16px;background:var(--white);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;font-size:13px;color:var(--gray);">
          Queue mode: <strong>${data.queue.mode || 'in-memory'}</strong>
          ${data.queue.mode === 'in-memory' ? ' â€” Set REDIS_URL in .env to enable persistent Bull queue' : ' â€” Redis connected'}
        </div>`;
    } catch (err) {
      document.getElementById('queueContent').innerHTML = '<div class="admin-loading">Failed to load queue data</div>';
    }
  }
</script>
<script src="sakura-assistant.js"></script>
</body>
</html>

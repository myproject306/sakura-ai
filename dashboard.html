<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard â€” Sakura AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .usage-meter { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 24px; }
    .usage-meter-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .usage-meter-header h3 { font-size: 14px; font-weight: 700; color: var(--dark); }
    .usage-row { margin-bottom: 14px; }
    .usage-row:last-child { margin-bottom: 0; }
    .usage-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--gray); margin-bottom: 6px; }
    .usage-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .usage-bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s ease; }
    .usage-bar-fill.tokens  { background: var(--gradient-pink); }
    .usage-bar-fill.credits { background: linear-gradient(135deg, #F59E0B, #D97706); }
    .usage-bar-fill.danger  { background: linear-gradient(135deg, #EF4444, #DC2626); }
    .plan-status-card {
      background: var(--gradient-pink); border-radius: var(--radius-md);
      padding: 20px; color: white; margin-bottom: 24px;
    }
    .plan-status-card h4 { font-size: 13px; opacity: 0.85; margin-bottom: 4px; }
    .plan-status-card .plan-name-lg { font-size: 20px; font-weight: 800; margin-bottom: 8px; }
    .plan-status-card .plan-detail { font-size: 12px; opacity: 0.8; }
    .btn-billing { width: 100%; padding: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: var(--radius-full); font-size: 13px; font-weight: 600; color: white; cursor: pointer; transition: var(--transition); font-family: inherit; margin-top: 12px; }
    .btn-billing:hover { background: rgba(255,255,255,0.3); }
    .project-output-preview { font-size: 12px; color: var(--light-gray); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
    .empty-state { text-align: center; padding: 48px 24px; color: var(--light-gray); }
    .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state p { font-size: 14px; line-height: 1.7; }
    .subscription-alert { background: #FEF3C7; border: 1px solid #FCD34D; border-radius: var(--radius-md); padding: 14px 18px; margin-bottom: 20px; font-size: 13px; color: #92400E; display: flex; align-items: center; gap: 10px; }
    .subscription-alert a { color: #92400E; font-weight: 700; text-decoration: underline; }
  </style>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#e8547a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Sakura AI" />
  <link rel="apple-touch-icon" href="icons/icon.svg" />
</head>
<body>

<nav class="navbar">
  <div class="container">
    <a href="index.html" class="logo">
      <div class="logo-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="8.5" cy="17" r="4" fill="white"/><circle cx="15.5" cy="17" r="4" fill="white"/><path d="M8.5 13C8.5 10 11 7.5 12 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M15.5 13C15.5 10 13 7.5 12 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M12 5C12.5 3.5 14 2.5 15.5 3" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
      Sakura <span class="brand">AI</span>
    </a>
    <ul class="nav-links">
      <li><a href="tools.html">AI Tools</a></li>
      <li><a href="pricing.html">Pricing</a></li>
      <li><a href="templates.html">Templates</a></li>
    </ul>
    <div class="nav-actions">
      <span id="navUserName" style="font-size:13px;font-weight:600;color:var(--dark);"></span>
      <button class="btn-ghost" onclick="handleLogout()">Log Out</button>
      <div class="hamburger" onclick="this.closest('nav').querySelector('.nav-links').classList.toggle('mobile-open')"><span></span><span></span><span></span></div>
    </div>
  </div>
</nav>

<div class="dashboard-layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-user">
      <div class="sidebar-avatar" id="sidebarAvatar">ğŸ‘¤</div>
      <div class="sidebar-user-info">
        <h4 id="sidebarName">Loading...</h4>
        <span id="sidebarPlan">Free Account</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <h5>Main</h5>
      <ul>
        <li><a href="dashboard.html" class="active"><span class="nav-icon">ğŸ </span> Dashboard</a></li>
        <li><a href="tools.html"><span class="nav-icon">ğŸ¤–</span> AI Tools</a></li>
        <li><a href="templates.html"><span class="nav-icon">ğŸ“š</span> Templates</a></li>
      </ul>
      <h5>Projects</h5>
      <ul>
        <li><a href="#" onclick="showSection('projects')"><span class="nav-icon">ğŸ“</span> My Projects</a></li>
        <li><a href="#" onclick="showSection('favorites')"><span class="nav-icon">â­</span> Favorites</a></li>
      </ul>
      <h5>Account</h5>
      <ul>
        <li><a href="#" onclick="openBillingPortal()"><span class="nav-icon">ğŸ’³</span> Billing</a></li>
        <li><a href="pricing.html"><span class="nav-icon">â¬†ï¸</span> Upgrade Plan</a></li>
        <li><a href="faq.html"><span class="nav-icon">â“</span> Help Center</a></li>
        <li><a href="#" onclick="handleLogout()"><span class="nav-icon">ğŸšª</span> Log Out</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main">

    <!-- Subscription alert (shown if no active plan) -->
    <div class="subscription-alert" id="subscriptionAlert" style="display:none;">
      âš ï¸ You're on the free plan. <a href="pricing.html">Upgrade to unlock all AI tools â†’</a>
    </div>

    <!-- Header -->
    <div class="dash-header">
      <div>
        <h1 id="dashGreeting">Good morning ğŸŒ¸</h1>
        <p>What would you like to create today?</p>
      </div>
      <a href="tools.html" class="btn-primary-lg" style="text-decoration:none;">
        <i class="fas fa-plus"></i> New Project
      </a>
    </div>

    <!-- Stats -->
    <div class="dash-stats" id="dashStats">
      <div class="dash-stat-card">
        <div class="dash-stat-icon">ğŸ“</div>
        <div class="dash-stat-num" id="statProjects">â€”</div>
        <div class="dash-stat-label">Total Projects</div>
      </div>
      <div class="dash-stat-card">
        <div class="dash-stat-icon">ğŸ¤–</div>
        <div class="dash-stat-num" id="statGenerations">â€”</div>
        <div class="dash-stat-label">AI Generations</div>
      </div>
      <div class="dash-stat-card">
        <div class="dash-stat-icon">â­</div>
        <div class="dash-stat-num" id="statFavorites">â€”</div>
        <div class="dash-stat-label">Favorites</div>
      </div>
      <div class="dash-stat-card">
        <div class="dash-stat-icon">ğŸª™</div>
        <div class="dash-stat-num" id="statCredits">â€”</div>
        <div class="dash-stat-label">Credits Left</div>
      </div>
    </div>

    <!-- Usage Meter -->
    <div class="usage-meter" id="usageMeter">
      <div class="usage-meter-header">
        <h3>ğŸ“Š Usage This Month</h3>
        <a href="pricing.html" style="font-size:12px;color:var(--primary-deep);font-weight:600;">Upgrade Plan â†’</a>
      </div>
      <div class="usage-row">
        <div class="usage-label">
          <span>Tokens (Text/Code)</span>
          <span id="tokenUsageText">Loading...</span>
        </div>
        <div class="usage-bar"><div class="usage-bar-fill tokens" id="tokenBar" style="width:0%"></div></div>
      </div>
      <div class="usage-row">
        <div class="usage-label">
          <span>Credits (Image/Audio)</span>
          <span id="creditUsageText">Loading...</span>
        </div>
        <div class="usage-bar"><div class="usage-bar-fill credits" id="creditBar" style="width:0%"></div></div>
      </div>
    </div>

    <!-- Plan Status -->
    <div class="plan-status-card" id="planStatusCard">
      <h4>Current Plan</h4>
      <div class="plan-name-lg" id="planNameLg">Free</div>
      <div class="plan-detail" id="planDetail">Upgrade to access all AI tools</div>
      <button class="btn-billing" onclick="openBillingPortal()" id="billingBtn" style="display:none;">
        <i class="fas fa-credit-card"></i> Manage Billing
      </button>
      <a href="pricing.html" class="btn-billing" style="text-decoration:none;display:block;text-align:center;" id="upgradeBtn">
        <i class="fas fa-arrow-up"></i> Upgrade Plan
      </a>
    </div>

    <!-- Quick Access Tools -->
    <div class="dash-section-title">âš¡ Quick Access</div>
    <div class="dash-tools-grid">
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=article-writer'">
        <span class="emoji">âœï¸</span><span>Article Writer</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=text-to-image'">
        <span class="emoji">ğŸ¨</span><span>Image Generator</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=code-generator'">
        <span class="emoji">ğŸ’»</span><span>Code Generator</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=email-writer'">
        <span class="emoji">ğŸ“§</span><span>Email Writer</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=excel-csv-analyzer'">
        <span class="emoji">ğŸ“Š</span><span>Data Analyzer</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=text-to-speech'">
        <span class="emoji">ğŸ§</span><span>Text to Speech</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=study-plan'">
        <span class="emoji">ğŸ“š</span><span>Study Planner</span>
      </button>
      <button class="dash-tool-btn" onclick="window.location.href='tool-interface.html?tool=business-plan'">
        <span class="emoji">ğŸ§ </span><span>Business Plan</span>
      </button>
    </div>

    <!-- Recent Projects -->
    <div class="dash-section-title" id="projectsSection">ğŸ“ Recent Projects</div>
    <div class="dash-projects" id="projectsContainer">
      <div class="dash-projects-header">
        <h3>Recent Projects</h3>
        <a href="#" onclick="loadAllProjects()" style="font-size:13px;color:var(--primary-deep);font-weight:600;">View All â†’</a>
      </div>
      <div id="projectsList">
        <div style="text-align:center;padding:32px;color:var(--light-gray);font-size:14px;">
          <i class="fas fa-spinner fa-spin"></i> Loading projects...
        </div>
      </div>
    </div>

  </main>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('ğŸŒ¸ SW registered'))
        .catch(err => console.warn('SW registration failed:', err));
    });
  }
</script>
<script src="config.js"></script>
<script src="script.js"></script>
<script>
  const API_BASE = SAKURA_CONFIG.API_BASE;

  const IS_DEMO = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
  const token = localStorage.getItem('sakura_token');

  // â”€â”€ Auth check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!token) { window.location.href = 'auth.html'; }

  // â”€â”€ Shared UI updater â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function populateDashboard(user) {
    const hour = new Date().getHours();
    const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('dashGreeting').textContent = `${greeting}, ${user.firstName || user.name?.split(' ')[0] || 'there'} ğŸŒ¸`;
    document.getElementById('navUserName').textContent  = user.name || user.email;
    document.getElementById('sidebarName').textContent  = user.name || user.email;

    const planIcons = { free: 'ğŸŒ±', starter: 'ğŸŒ±', pro: 'ğŸŒ¸', team: 'ğŸ¢' };
    const planNames = { free: 'Free Account', starter: 'Starter Plan', pro: 'Pro Plan', team: 'Team Plan' };
    document.getElementById('sidebarPlan').textContent = planNames[user.plan] || 'Free Account';
    document.getElementById('sidebarPlan').style.color = user.plan !== 'free' ? 'var(--primary-deep)' : '';
    document.getElementById('planNameLg').textContent  = `${planIcons[user.plan] || 'ğŸŒ±'} ${planNames[user.plan] || 'Free'}`;

    const isActive = user.subscriptionStatus === 'active' || user.subscriptionStatus === 'trialing';
    if (isActive) {
      const trialEnd  = user.trialEndsAt ? new Date(user.trialEndsAt).toLocaleDateString() : '';
      const periodEnd = user.currentPeriodEnd ? new Date(user.currentPeriodEnd).toLocaleDateString() : '';
      document.getElementById('planDetail').textContent = user.subscriptionStatus === 'trialing'
        ? `Free trial ends ${trialEnd}` : `Renews ${periodEnd}`;
      document.getElementById('billingBtn').style.display = 'block';
      document.getElementById('upgradeBtn').style.display = 'none';
    } else {
      document.getElementById('subscriptionAlert').style.display = 'flex';
    }
    document.getElementById('statCredits').textContent = user.credits ?? 'â€”';
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function init() {
    // â”€â”€ Demo mode: use localStorage data directly â”€â”€
    if (IS_DEMO) {
      try {
        const user = JSON.parse(localStorage.getItem('sakura_user') || '{}');
        if (!user.email) { handleLogout(); return; }
        populateDashboard(user);
        // Demo stats
        document.getElementById('statProjects').textContent    = '0';
        document.getElementById('statGenerations').textContent = '0';
        document.getElementById('statFavorites').textContent   = '0';
        // Demo usage
        document.getElementById('tokenUsageText').textContent  = '0 / 50,000';
        document.getElementById('tokenBar').style.width        = '0%';
        document.getElementById('creditUsageText').textContent = '0 / 100 used';
        document.getElementById('creditBar').style.width       = '0%';
        // Empty projects
        document.getElementById('projectsList').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <p>No projects yet.<br>Use an AI tool to create your first project!</p>
            <a href="tools.html" class="btn-primary-lg" style="text-decoration:none;display:inline-flex;margin-top:16px;font-size:14px;padding:10px 24px;">
              <i class="fas fa-robot"></i> Explore AI Tools
            </a>
          </div>`;
      } catch (err) {
        console.error('Demo dashboard error:', err);
      }
      return;
    }

    // â”€â”€ Live mode: fetch from API â”€â”€
    try {
      const res  = await fetch(`${API_BASE}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      if (!res.ok) { handleLogout(); return; }

      const user = data.user;
      localStorage.setItem('sakura_user', JSON.stringify(user));
      populateDashboard(user);
      loadStats();
      loadUsage();
      loadRecentProjects();

    } catch (err) {
      console.error('Dashboard init error:', err);
    }
  })();

  // â”€â”€ Load Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadStats() {
    try {
      const res  = await fetch(`${API_BASE}/projects/stats`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (!res.ok) return;

      document.getElementById('statProjects').textContent    = data.totalProjects;
      document.getElementById('statGenerations').textContent = data.totalGenerations;
      document.getElementById('statFavorites').textContent   = data.favorites;
    } catch (_) {}
  }

  // â”€â”€ Load Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsage() {
    try {
      const res  = await fetch(`${API_BASE}/tools/usage`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (!res.ok) return;

      document.getElementById('tokenUsageText').textContent =
        `${data.tokens.used.toLocaleString()} / ${data.tokens.limit.toLocaleString()}`;
      document.getElementById('tokenBar').style.width = `${data.tokens.percentage}%`;
      if (data.tokens.percentage > 90) document.getElementById('tokenBar').classList.add('danger');

      document.getElementById('creditUsageText').textContent =
        `${data.credits.used} / ${data.credits.limit} used`;
      document.getElementById('creditBar').style.width = `${data.credits.percentage}%`;
      if (data.credits.percentage > 90) document.getElementById('creditBar').classList.add('danger');

    } catch (_) {}
  }

  // â”€â”€ Load Recent Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadRecentProjects() {
    try {
      const res  = await fetch(`${API_BASE}/projects?limit=5&sortBy=createdAt&order=desc`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (!res.ok) return;

      const list = document.getElementById('projectsList');

      if (!data.projects || data.projects.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <p>No projects yet.<br>Use an AI tool to create your first project!</p>
            <a href="tools.html" class="btn-primary-lg" style="text-decoration:none;display:inline-flex;margin-top:16px;font-size:14px;padding:10px 24px;">
              <i class="fas fa-robot"></i> Explore AI Tools
            </a>
          </div>`;
        return;
      }

      const categoryEmojis = { writing:'âœï¸', image:'ğŸ¨', audio:'ğŸ§', code:'ğŸ’»', data:'ğŸ“Š', study:'ğŸ“š', business:'ğŸ§ ', specialized:'ğŸ¯' };

      list.innerHTML = data.projects.map(p => `
        <div class="project-row" onclick="window.location.href='tool-interface.html?tool=${p.toolName}'" style="cursor:pointer;">
          <div class="project-info">
            <div class="project-icon">${categoryEmojis[p.category] || 'ğŸ“„'}</div>
            <div>
              <div class="project-name">${p.title}</div>
              <div class="project-output-preview">${p.outputPreview || ''}</div>
              <div class="project-date">${formatDate(p.createdAt)}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="project-tag">${p.category}</span>
            <button onclick="event.stopPropagation();toggleFavorite('${p.id}', this)" style="background:none;border:none;cursor:pointer;font-size:16px;color:${p.isFavorite ? '#FF4D8D' : 'var(--light-gray)'};">
              ${p.isFavorite ? 'â˜…' : 'â˜†'}
            </button>
          </div>
        </div>
      `).join('');

    } catch (_) {}
  }

  // â”€â”€ Toggle Favorite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function toggleFavorite(projectId, btn) {
    try {
      const res  = await fetch(`${API_BASE}/projects/${projectId}/favorite`, {
        method: 'PUT', headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (res.ok) {
        btn.textContent = data.isFavorite ? 'â˜…' : 'â˜†';
        btn.style.color = data.isFavorite ? '#FF4D8D' : 'var(--light-gray)';
      }
    } catch (_) {}
  }

  // â”€â”€ Open Billing Portal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openBillingPortal() {
    try {
      showToast('Opening billing portal...');
      const res  = await fetch(`${API_BASE}/stripe/customer-portal`, {
        method: 'POST', headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (data.url) window.open(data.url, '_blank');
      else showToast('âŒ ' + (data.error || 'Failed to open billing portal'));
    } catch (err) {
      showToast('âŒ Failed to open billing portal');
    }
  }

  // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleLogout() {
    try {
      await fetch(`${API_BASE}/auth/logout`, {
        method: 'POST', headers: { Authorization: `Bearer ${token}` },
      });
    } catch (_) {}
    localStorage.removeItem('sakura_token');
    localStorage.removeItem('sakura_refresh');
    localStorage.removeItem('sakura_user');
    window.location.href = 'index.html';
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function formatDate(dateStr) {
    const d = new Date(dateStr);
    const now = new Date();
    const diff = now - d;
    if (diff < 60000)    return 'Just now';
    if (diff < 3600000)  return `${Math.floor(diff/60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
    if (diff < 604800000) return `${Math.floor(diff/86400000)}d ago`;
    return d.toLocaleDateString();
  }

  function loadAllProjects() {
    window.location.href = 'tools.html';
  }

  function showSection(section) {
    document.getElementById('projectsSection').scrollIntoView({ behavior: 'smooth' });
  }
</script>
<script src="sakura-assistant.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Tool ‚Äî Sakura AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .tool-page { margin-top:70px; min-height:calc(100vh - 70px); background:var(--accent); }
    .tool-header { background:var(--white); border-bottom:1px solid var(--border); padding:20px 0; }
    .tool-header-inner { display:flex; align-items:center; gap:16px; }
    .tool-header-icon { width:52px; height:52px; background:var(--gradient-pink); border-radius:var(--radius-md); display:flex; align-items:center; justify-content:center; font-size:24px; flex-shrink:0; }
    .tool-header-info h1 { font-size:22px; font-weight:800; color:var(--dark); }
    .tool-header-info p  { font-size:13px; color:var(--gray); margin-top:2px; }
    .tool-header-actions { margin-left:auto; display:flex; gap:10px; align-items:center; }
    .tool-content-area { max-width:780px; margin:0 auto; padding:36px 20px 60px; }
    /* ‚îÄ‚îÄ Single Search Bar ‚îÄ‚îÄ */
    .search-bar-wrap { display:flex; align-items:center; background:var(--white); border:2px solid var(--border); border-radius:var(--radius-full); padding:6px 6px 6px 20px; box-shadow:var(--shadow-sm); transition:var(--transition); margin-bottom:24px; }
    .search-bar-wrap:focus-within { border-color:var(--primary); box-shadow:0 0 0 4px rgba(247,183,200,0.2); }
    .search-input { flex:1; border:none; outline:none; font-size:15px; font-family:inherit; color:var(--dark); background:transparent; padding:10px 0; }
    .search-input::placeholder { color:var(--light-gray); }
    .search-btn { flex-shrink:0; background:var(--gradient-pink); border:none; border-radius:var(--radius-full); padding:12px 22px; font-size:14px; font-weight:700; color:white; cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:8px; font-family:inherit; }
    .search-btn:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 6px 20px rgba(247,183,200,0.5); }
    .search-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
    /* ‚îÄ‚îÄ Usage bar (below search bar) ‚îÄ‚îÄ */
    .usage-bar-wrap { margin-bottom:24px; }
    .usage-bar-label { display:flex; justify-content:space-between; font-size:12px; color:var(--gray); margin-bottom:6px; }
    .usage-bar { height:4px; background:var(--border); border-radius:3px; overflow:hidden; }
    .usage-bar-fill { height:100%; background:var(--gradient-pink); border-radius:3px; transition:width 0.5s ease; }
    /* ‚îÄ‚îÄ Keep tool-field only for improve modal ‚îÄ‚îÄ */
    .tool-field { margin-bottom:18px; }
    .tool-field label { display:block; font-size:13px; font-weight:600; color:var(--dark); margin-bottom:7px; }
    .tool-field textarea { width:100%; padding:12px 16px; border:1.5px solid var(--border); border-radius:var(--radius-sm); font-size:13px; font-family:inherit; color:var(--dark); background:var(--white); transition:var(--transition); outline:none; box-sizing:border-box; resize:vertical; min-height:110px; }
    .tool-field textarea:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(247,183,200,0.2); }
    .tool-loading-card { background:var(--white); border:1px solid var(--border); border-radius:var(--radius-lg); padding:48px 28px; box-shadow:var(--shadow-sm); display:none; flex-direction:column; align-items:center; justify-content:center; gap:18px; text-align:center; margin-bottom:24px; }
    .tool-loading-card.visible { display:flex; }
    .loading-dots { display:flex; gap:8px; }
    .loading-dots .dot { width:12px; height:12px; background:var(--primary); border-radius:50%; animation:dotBounce 1.2s infinite; }
    .loading-dots .dot:nth-child(2) { animation-delay:0.2s; }
    .loading-dots .dot:nth-child(3) { animation-delay:0.4s; }
    @keyframes dotBounce { 0%,80%,100%{transform:scale(0.8);opacity:0.5} 40%{transform:scale(1.2);opacity:1} }
    .loading-label { font-size:14px; color:var(--gray); font-weight:500; }
    .tool-result-card { background:var(--white); border:1px solid var(--border); border-radius:var(--radius-lg); padding:28px; box-shadow:var(--shadow-sm); display:none; animation:slideUp 0.4s cubic-bezier(0.4,0,0.2,1); }
    .tool-result-card.visible { display:block; }
    @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    .result-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; padding-bottom:14px; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:10px; }
    .result-badge { display:inline-flex; align-items:center; gap:6px; background:var(--secondary); color:var(--primary-deep); font-size:12px; font-weight:700; padding:5px 12px; border-radius:var(--radius-full); }
    .result-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn-result-action { padding:7px 14px; border-radius:var(--radius-full); font-size:12px; font-weight:600; cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:5px; font-family:inherit; }
    .btn-result-action.outline { background:transparent; border:1.5px solid var(--border); color:var(--gray); }
    .btn-result-action.outline:hover { border-color:var(--primary); color:var(--primary-deep); background:var(--secondary); }
    .btn-result-action.pink { background:var(--gradient-pink); border:none; color:white; }
    .btn-result-action.pink:hover { transform:translateY(-1px); box-shadow:var(--shadow-sm); }
    .result-text { background:var(--accent); border:1px solid var(--border); border-radius:var(--radius-md); padding:20px; font-size:14px; color:var(--dark); line-height:1.85; white-space:pre-wrap; overflow-y:auto; max-height:520px; min-height:120px; }
    .result-text.code-output { font-family:'Courier New',monospace; font-size:13px; background:#1e1e2e; color:#cdd6f4; border-color:#313244; }
    .result-image { max-width:100%; border-radius:var(--radius-md); display:block; margin:0 auto; }
    .result-audio { width:100%; margin-top:12px; }
    .result-meta { display:flex; gap:16px; margin-top:14px; padding-top:12px; border-top:1px solid var(--border); flex-wrap:wrap; }
    .result-meta-item { font-size:11px; color:var(--light-gray); display:flex; align-items:center; gap:4px; }
    /* ‚îÄ‚îÄ Free tier blur overlay ‚îÄ‚îÄ */
    .free-blur-wrap { position:relative; }
    .free-blur-overlay { position:absolute; bottom:0; left:0; right:0; height:160px; background:linear-gradient(to bottom, transparent, rgba(255,255,255,0.97)); border-radius:0 0 var(--radius-md) var(--radius-md); display:flex; flex-direction:column; align-items:center; justify-content:flex-end; padding-bottom:20px; gap:10px; }
    .free-blur-overlay .blur-msg { font-size:13px; font-weight:700; color:var(--dark); text-align:center; }
    .free-blur-overlay .blur-msg span { color:var(--primary-deep); }
    .btn-unlock { background:var(--gradient-pink); border:none; border-radius:var(--radius-full); padding:10px 28px; font-size:13px; font-weight:700; color:white; cursor:pointer; font-family:inherit; transition:var(--transition); display:inline-flex; align-items:center; gap:7px; text-decoration:none; }
    .btn-unlock:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(247,183,200,0.5); }
    /* ‚îÄ‚îÄ Free upgrade banner ‚îÄ‚îÄ */
    .free-upgrade-banner { background:linear-gradient(135deg,#fff0f5,#fce4ec); border:1.5px solid var(--primary); border-radius:var(--radius-lg); padding:18px 22px; margin-top:20px; display:none; }
    .free-upgrade-banner.visible { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .free-upgrade-banner .ban-icon { font-size:28px; flex-shrink:0; }
    .free-upgrade-banner .ban-text { flex:1; min-width:200px; }
    .free-upgrade-banner .ban-text strong { display:block; font-size:14px; font-weight:800; color:var(--dark); margin-bottom:3px; }
    .free-upgrade-banner .ban-text span { font-size:12px; color:var(--gray); }
    .free-upgrade-banner .ban-btn { background:var(--gradient-pink); border:none; border-radius:var(--radius-full); padding:10px 22px; font-size:13px; font-weight:700; color:white; cursor:pointer; font-family:inherit; white-space:nowrap; text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
    /* ‚îÄ‚îÄ Free daily counter ‚îÄ‚îÄ */
    .free-daily-bar { background:var(--white); border:1px solid var(--border); border-radius:var(--radius-md); padding:12px 16px; margin-bottom:16px; display:none; }
    .free-daily-bar.visible { display:flex; align-items:center; gap:12px; }
    .free-daily-dots { display:flex; gap:5px; }
    .free-daily-dot { width:10px; height:10px; border-radius:50%; background:var(--border); transition:background 0.3s; }
    .free-daily-dot.used { background:var(--primary); }
    .free-daily-text { font-size:12px; color:var(--gray); flex:1; }
    .free-daily-text strong { color:var(--dark); }
    /* ‚îÄ‚îÄ Locked button style ‚îÄ‚îÄ */
    .btn-result-action.locked { opacity:0.5; cursor:not-allowed; position:relative; }
    .btn-result-action.locked::after { content:'üîí Pro'; position:absolute; top:-22px; left:50%; transform:translateX(-50%); background:#333; color:white; font-size:10px; padding:2px 7px; border-radius:4px; white-space:nowrap; opacity:0; transition:opacity 0.2s; pointer-events:none; }
    .btn-result-action.locked:hover::after { opacity:1; }
    /* ‚îÄ‚îÄ Free tool badge ‚îÄ‚îÄ */
    .free-tool-notice { background:var(--secondary); border:1px solid var(--primary); border-radius:var(--radius-md); padding:10px 16px; margin-bottom:16px; font-size:12px; color:var(--primary-deep); display:none; }
    .free-tool-notice.visible { display:flex; align-items:center; gap:8px; }
    .improve-modal { position:fixed; inset:0; background:rgba(44,44,44,0.5); backdrop-filter:blur(4px); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
    .improve-modal.open { display:flex; }
    .improve-box { background:var(--white); border-radius:var(--radius-lg); padding:32px; max-width:480px; width:100%; animation:modalIn 0.3s cubic-bezier(0.4,0,0.2,1); }
    @keyframes modalIn { from{opacity:0;transform:scale(0.95) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .improve-box h3 { font-size:18px; font-weight:800; margin-bottom:8px; }
    .improve-box p  { font-size:13px; color:var(--gray); margin-bottom:16px; }
    @media(max-width:600px){.tool-content-area{padding:20px 14px 48px}.tool-search-card,.tool-result-card{padding:20px}.result-header{flex-direction:column;align-items:flex-start}.tool-header-actions .btn-result-action{display:none}}
  </style>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#e8547a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Sakura AI" />
  <link rel="apple-touch-icon" href="icons/icon.svg" />
</head>
<body>

<nav class="navbar">
  <div class="container">
    <a href="index.html" class="logo">
      <div class="logo-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="8.5" cy="17" r="4" fill="white"/><circle cx="15.5" cy="17" r="4" fill="white"/><path d="M8.5 13C8.5 10 11 7.5 12 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M15.5 13C15.5 10 13 7.5 12 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M12 5C12.5 3.5 14 2.5 15.5 3" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
      Sakura <span class="brand">AI</span>
    </a>
    <ul class="nav-links">
      <li><a href="tools.html">AI Tools</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
    </ul>
    <div class="nav-actions">
      <a href="dashboard.html" class="btn-ghost" style="text-decoration:none;" id="navUserName">Dashboard</a>
      <div class="hamburger" onclick="this.closest('nav').querySelector('.nav-links').classList.toggle('mobile-open')"><span></span><span></span><span></span></div>
    </div>
  </div>
</nav>

<div class="tool-page">
  <div class="tool-header">
    <div class="container">
      <div class="tool-header-inner">
        <div class="tool-header-icon" id="toolHeaderIcon">ü§ñ</div>
        <div class="tool-header-info">
          <h1 id="toolHeaderTitle">AI Tool</h1>
          <p id="toolHeaderDesc">Powered by Sakura AI</p>
        </div>
        <div class="tool-header-actions">
          <a href="tools.html" class="btn-result-action outline" style="text-decoration:none;"><i class="fas fa-arrow-left"></i> All Tools</a>
          <a href="dashboard.html" class="btn-result-action outline" style="text-decoration:none;"><i class="fas fa-folder"></i> My Projects</a>
        </div>
      </div>
    </div>
  </div>

  <div class="tool-content-area">

    <!-- Single-line search bar -->
    <div class="search-bar-wrap">
      <input type="text" class="search-input" id="askInput" placeholder="Ask anything..." autocomplete="off" onkeydown="if(event.key==='Enter')runTool()" />
      <button class="search-btn" id="runBtn" onclick="runTool()">
        <span id="runBtnText"><i class="fas fa-paper-plane"></i> Send</span>
        <span id="runBtnLoader" style="display:none;"><i class="fas fa-spinner fa-spin"></i></span>
      </button>
    </div>

    <!-- Free daily counter (shown only for free users) -->
    <div class="free-daily-bar" id="freeDailyBar">
      <div class="free-daily-dots" id="freeDailyDots"></div>
      <div class="free-daily-text" id="freeDailyText">Loading...</div>
      <a href="pricing.html" class="btn-unlock" style="padding:6px 16px;font-size:11px;">‚ö° Upgrade</a>
    </div>

    <!-- Free tool notice -->
    <div class="free-tool-notice" id="freeToolNotice">
      <i class="fas fa-info-circle"></i>
      <span>Free plan: 6 basic tools available. <a href="pricing.html" style="color:var(--primary-deep);font-weight:700;">Upgrade</a> to unlock all 35+ tools.</span>
    </div>

    <!-- Usage bar -->
    <div class="usage-bar-wrap" id="usageMeter">
      <div class="usage-bar-label"><span>Monthly Usage</span><span id="usageText">‚Äî / ‚Äî</span></div>
      <div class="usage-bar"><div class="usage-bar-fill" id="usageBarFill" style="width:0%"></div></div>
    </div>

    <div class="tool-loading-card" id="loadingCard">
      <div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <p class="loading-label" id="loadingText">Generating your result...</p>
    </div>

    <div class="tool-result-card" id="resultCard">
      <div class="result-header">
        <span class="result-badge"><i class="fas fa-magic"></i> Result</span>
        <div class="result-actions">
          <button class="btn-result-action outline" onclick="copyOutput()"><i class="fas fa-copy"></i> Copy</button>
          <button class="btn-result-action outline" id="btnImprove" onclick="openImproveModal()"><i class="fas fa-wand-magic-sparkles"></i> Improve</button>
          <button class="btn-result-action outline" id="btnRegenerate" onclick="regenerate()"><i class="fas fa-redo"></i> Regenerate</button>
          <button class="btn-result-action pink" id="btnSave" onclick="saveProject()"><i class="fas fa-save"></i> Save</button>
        </div>
      </div>
      <!-- Output text wrapped for potential blur overlay -->
      <div style="position:relative;" id="outputWrap">
        <div class="result-text" id="outputText"></div>
        <!-- Free blur overlay (shown when output is truncated) -->
        <div class="free-blur-overlay" id="freeBlurOverlay" style="display:none;">
          <div class="blur-msg">‚ú® <span>200+ more words</span> hidden ‚Äî Upgrade to see the full result</div>
          <a href="pricing.html" class="btn-unlock"><i class="fas fa-lock-open"></i> Unlock Full Result</a>
        </div>
      </div>
      <div class="result-meta" id="outputMeta"></div>
      <!-- Free upgrade banner (shown after result for free users) -->
      <div class="free-upgrade-banner" id="freeUpgradeBanner">
        <div class="ban-icon">üå∏</div>
        <div class="ban-text">
          <strong>You're on the Free Plan</strong>
          <span>Upgrade to Pro for full results, 35+ tools, Improve & Regenerate features, and 100x more tokens.</span>
        </div>
        <a href="pricing.html" class="ban-btn"><i class="fas fa-rocket"></i> Upgrade to Pro ‚Äî $29/mo</a>
      </div>
    </div>
  </div>
</div>

<div class="improve-modal" id="improveModal">
  <div class="improve-box">
    <h3>‚ú® Improve Result</h3>
    <p>Tell the AI how to improve the output:</p>
    <div class="tool-field">
      <textarea id="improveInstruction" placeholder="e.g. Make it more formal, add more detail, shorten it, translate to Arabic..." rows="4"></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn-result-action pink" style="flex:1;padding:12px;justify-content:center;" onclick="submitImprove()"><i class="fas fa-wand-magic-sparkles"></i> Improve</button>
      <button class="btn-result-action outline" style="flex:1;padding:12px;justify-content:center;" onclick="document.getElementById('improveModal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('üå∏ SW registered'))
        .catch(err => console.warn('SW registration failed:', err));
    });
  }
</script>
<script src="config.js"></script>
<script src="script.js"></script>
<script>
const API_BASE = SAKURA_CONFIG.API_BASE;
const IS_DEMO  = SAKURA_CONFIG.DEMO_MODE;

let currentTool=null, currentCategory=null, currentProjectId=null, currentOutput=null;
let authToken = localStorage.getItem('sakura_token');
let isFreeUser = false;
let freeDailyRemaining = 5;

const TOOLS = {
  'article-writer':      {icon:'üìù',title:'Article Writer',      desc:'Generate full blog posts and articles',category:'writing', fields:[{id:'topic',label:'Topic',type:'text',placeholder:'e.g. The future of AI in healthcare'},{id:'audience',label:'Target Audience',type:'text',placeholder:'e.g. Healthcare professionals'},{id:'tone',label:'Tone',type:'select',options:['Professional','Casual','Academic','Conversational']},{id:'length',label:'Word Count',type:'select',options:['500','800','1200','2000']}]},
  'email-writer':        {icon:'üìß',title:'Email Writer',         desc:'Write professional emails',category:'writing', fields:[{id:'recipient',label:'Recipient',type:'text',placeholder:'e.g. Client, Manager, Team'},{id:'subject',label:'Subject',type:'text',placeholder:'e.g. Project update'},{id:'keyPoints',label:'Key Points',type:'textarea',placeholder:'What should the email cover?'},{id:'tone',label:'Tone',type:'select',options:['Professional','Formal','Friendly','Urgent']}]},
  'social-media-posts':  {icon:'üì±',title:'Social Media Posts',  desc:'Create engaging social content',category:'writing', fields:[{id:'platform',label:'Platform',type:'select',options:['Instagram','Twitter/X','LinkedIn','Facebook','TikTok']},{id:'topic',label:'Topic / Product',type:'text',placeholder:'What is the post about?'},{id:'tone',label:'Tone',type:'select',options:['Engaging','Professional','Humorous','Inspirational']},{id:'goal',label:'Goal',type:'select',options:['Engagement','Brand Awareness','Sales','Education']}]},
  'text-summarizer':     {icon:'üîÑ',title:'Text Summarizer',      desc:'Summarize long documents instantly',category:'writing', fields:[{id:'text',label:'Text to Summarize',type:'textarea',placeholder:'Paste your text here...',rows:8},{id:'length',label:'Summary Length',type:'select',options:['Brief (2-3 sentences)','Medium (1 paragraph)','Detailed (3-5 paragraphs)']}]},
  'text-rewriter':       {icon:'‚ú®',title:'Text Rewriter',        desc:'Rewrite and improve any text',category:'writing', fields:[{id:'text',label:'Text to Rewrite',type:'textarea',placeholder:'Paste your text here...',rows:6},{id:'tone',label:'Target Tone',type:'select',options:['Professional','Casual','Academic','Persuasive','Simple']},{id:'goal',label:'Goal',type:'select',options:['Improve clarity','Make it shorter','Make it longer','Fix grammar','Change tone']}]},
  'marketing-copy':      {icon:'üéØ',title:'Marketing Copy',       desc:'High-converting marketing content',category:'writing', fields:[{id:'product',label:'Product / Service',type:'text',placeholder:'e.g. AI writing tool'},{id:'audience',label:'Target Audience',type:'text',placeholder:'e.g. Small business owners'},{id:'mainBenefit',label:'Main Benefit',type:'text',placeholder:'e.g. Save 10 hours per week'},{id:'cta',label:'Call to Action',type:'text',placeholder:'e.g. Start free trial'}]},
  'code-generator':      {icon:'‚ö°',title:'Code Generator',       desc:'Generate code in any language',category:'code', fields:[{id:'language',label:'Programming Language',type:'select',options:['JavaScript','Python','TypeScript','Java','C++','C#','PHP','Go','Rust','Swift','Kotlin','SQL']},{id:'framework',label:'Framework (optional)',type:'text',placeholder:'e.g. React, Django, Express'},{id:'description',label:'What should the code do?',type:'textarea',placeholder:'Describe the function or feature you need...',rows:5}]},
  'bug-fixer':           {icon:'üêõ',title:'Bug Fixer',            desc:'Detect and fix code bugs',category:'code', fields:[{id:'language',label:'Programming Language',type:'select',options:['JavaScript','Python','TypeScript','Java','C++','C#','PHP','Go','Other']},{id:'code',label:'Paste Your Code',type:'textarea',placeholder:'Paste the buggy code here...',rows:10}]},
  'code-explainer':      {icon:'üìñ',title:'Code Explainer',       desc:'Understand code in plain language',category:'code', fields:[{id:'language',label:'Programming Language',type:'select',options:['JavaScript','Python','TypeScript','Java','C++','C#','PHP','Go','Other']},{id:'code',label:'Code to Explain',type:'textarea',placeholder:'Paste the code you want explained...',rows:10}]},
  'documentation-writer':{icon:'üìÑ',title:'Documentation Writer', desc:'Auto-generate documentation',category:'code', fields:[{id:'language',label:'Programming Language',type:'select',options:['JavaScript','Python','TypeScript','Java','C++','C#','PHP','Go','Other']},{id:'code',label:'Code to Document',type:'textarea',placeholder:'Paste your code here...',rows:10}]},
  'automation-scripts':  {icon:'ü§ñ',title:'Automation Scripts',  desc:'Generate automation scripts',category:'code', fields:[{id:'language',label:'Language',type:'select',options:['Python','Bash','PowerShell','JavaScript','Other']},{id:'task',label:'Task to Automate',type:'textarea',placeholder:'Describe what you want to automate...',rows:5}]},
  'business-plan':       {icon:'üìä',title:'Business Plan Writer', desc:'Generate comprehensive business plans',category:'business', fields:[{id:'businessName',label:'Business Name',type:'text',placeholder:'e.g. TechFlow Solutions'},{id:'industry',label:'Industry',type:'text',placeholder:'e.g. SaaS, E-commerce, Healthcare'},{id:'targetMarket',label:'Target Market',type:'text',placeholder:'e.g. Small businesses in the Middle East'},{id:'investment',label:'Initial Investment',type:'text',placeholder:'e.g. $50,000'}]},
  'cv-resume':           {icon:'üìÑ',title:'CV & Resume Writer',   desc:'Create professional CVs',category:'business', fields:[{id:'jobTitle',label:'Target Job Title',type:'text',placeholder:'e.g. Senior Software Engineer'},{id:'experience',label:'Work Experience',type:'textarea',placeholder:'List your work experience...',rows:4},{id:'skills',label:'Key Skills',type:'text',placeholder:'e.g. Python, React, Project Management'},{id:'education',label:'Education',type:'text',placeholder:'e.g. BSc Computer Science, MIT 2020'},{id:'achievements',label:'Key Achievements',type:'textarea',placeholder:'Your notable achievements...',rows:3}]},
  'presentation-builder':{icon:'üñ•Ô∏è',title:'Presentation Builder', desc:'Create slide outlines and content',category:'business', fields:[{id:'topic',label:'Presentation Topic',type:'text',placeholder:'e.g. Q3 Sales Report'},{id:'slides',label:'Number of Slides',type:'select',options:['5','8','10','15','20']},{id:'audience',label:'Audience',type:'text',placeholder:'e.g. Investors, Students, Executives'}]},
  'sop-workflow':        {icon:'üìã',title:'SOP & Workflow Builder',desc:'Create standard operating procedures',category:'business', fields:[{id:'process',label:'Process Name',type:'text',placeholder:'e.g. Employee Onboarding'},{id:'department',label:'Department',type:'text',placeholder:'e.g. HR, Customer Support'},{id:'steps',label:'Key Steps (optional)',type:'textarea',placeholder:'List any known steps...',rows:4}]},
  'formal-email':        {icon:'‚úâÔ∏è',title:'Formal Email Writer',  desc:'Write formal business emails',category:'business', fields:[{id:'recipient',label:'Recipient',type:'text',placeholder:'e.g. CEO, Client, Government Office'},{id:'subject',label:'Subject',type:'text',placeholder:'e.g. Partnership Proposal'},{id:'keyPoints',label:'Key Points',type:'textarea',placeholder:'What should the email cover?',rows:4}]},
  'lesson-simplifier':   {icon:'üéì',title:'Lesson Simplifier',    desc:'Simplify complex topics',category:'study', fields:[{id:'topic',label:'Topic to Explain',type:'text',placeholder:'e.g. Quantum entanglement, Calculus derivatives'},{id:'level',label:'Student Level',type:'select',options:['Elementary','Middle School','High School','University','Adult Learner']}]},
  'qa-generator':        {icon:'‚ùì',title:'Q&A Generator',        desc:'Generate practice questions',category:'study', fields:[{id:'topic',label:'Topic / Subject',type:'text',placeholder:'e.g. World War II, Photosynthesis'},{id:'count',label:'Number of Questions',type:'select',options:['5','10','15','20']},{id:'difficulty',label:'Difficulty',type:'select',options:['Easy','Medium','Hard','Mixed']}]},
  'study-plan':          {icon:'üìÖ',title:'Study Plan Creator',   desc:'Create personalized study plans',category:'study', fields:[{id:'subject',label:'Subject',type:'text',placeholder:'e.g. Mathematics, IELTS, Programming'},{id:'examDate',label:'Exam / Goal Date',type:'text',placeholder:'e.g. 3 months from now, June 15'},{id:'currentLevel',label:'Current Level',type:'select',options:['Beginner','Intermediate','Advanced']},{id:'hoursPerDay',label:'Hours Available Per Day',type:'select',options:['1','2','3','4','5+']}]},
  'text-to-speech':      {icon:'üîä',title:'Text to Speech',       desc:'Convert text to natural audio',category:'audio', fields:[{id:'text',label:'Text to Convert',type:'textarea',placeholder:'Enter the text you want to convert to speech...',rows:6},{id:'language',label:'Language',type:'select',options:['English','Arabic']},{id:'stability',label:'Voice Stability',type:'select',options:['0.3','0.5','0.7','0.9']}]},
  'text-to-image':       {icon:'üñºÔ∏è',title:'Text to Image',        desc:'Generate images from descriptions',category:'image', fields:[{id:'prompt',label:'Image Description',type:'textarea',placeholder:'Describe the image you want to generate...',rows:4},{id:'style',label:'Style',type:'select',options:['photographic','digital-art','anime','cinematic','fantasy-art','neon-punk','3d-model']},{id:'negativePrompt',label:'Negative Prompt (optional)',type:'text',placeholder:'What to avoid in the image'}]},
  'excel-csv-analyzer':  {icon:'üìà',title:'Data Analyzer',        desc:'Analyze data and get insights',category:'data', fields:[{id:'data',label:'Paste Your Data (CSV or table)',type:'textarea',placeholder:'Paste your CSV data or table here...',rows:8},{id:'question',label:'What do you want to know?',type:'text',placeholder:'e.g. What are the top trends?'}]},
  'product-description': {icon:'üõí',title:'Product Description',  desc:'Write compelling product descriptions',category:'specialized', fields:[{id:'productName',label:'Product Name',type:'text',placeholder:'e.g. Wireless Headphones'},{id:'features',label:'Key Features',type:'textarea',placeholder:'List the main features...',rows:4},{id:'audience',label:'Target Audience',type:'text',placeholder:'e.g. Gamers, Professionals'}]},
  'ad-copy':             {icon:'üì£',title:'Ad Copy Generator',    desc:'Create high-converting ads',category:'specialized', fields:[{id:'product',label:'Product / Service',type:'text',placeholder:'e.g. Online fitness app'},{id:'platform',label:'Platform',type:'select',options:['Facebook','Google','TikTok','Instagram','LinkedIn']},{id:'goal',label:'Campaign Goal',type:'select',options:['Sales','Leads','Brand Awareness','App Downloads']},{id:'audience',label:'Target Audience',type:'text',placeholder:'e.g. Women 25-40 interested in fitness'}]},
  'customer-support':    {icon:'üí¨',title:'Customer Support',     desc:'Generate professional support responses',category:'specialized', fields:[{id:'issue',label:'Customer Issue',type:'textarea',placeholder:'Describe the customer issue...',rows:4},{id:'tone',label:'Tone',type:'select',options:['Empathetic','Professional','Friendly','Formal']}]},
  'social-calendar':     {icon:'üì≤',title:'Social Media Calendar',desc:'Plan a full month of social content',category:'specialized', fields:[{id:'brand',label:'Brand / Business',type:'text',placeholder:'e.g. Coffee Shop, Tech Startup'},{id:'platform',label:'Platform',type:'select',options:['Instagram','Twitter/X','LinkedIn','Facebook','TikTok']},{id:'month',label:'Month',type:'text',placeholder:'e.g. July 2025'}]}
};

(function init() {
  if (!authToken) {
    window.location.href = 'auth.html?redirect=' + encodeURIComponent(window.location.href);
    return;
  }
  const params = new URLSearchParams(window.location.search);
  const toolId = params.get('tool');
  if (!toolId || !TOOLS[toolId]) { window.location.href = 'tools.html'; return; }

  currentTool     = toolId;
  const tool      = TOOLS[toolId];
  currentCategory = tool.category;

  document.title = tool.title + ' ‚Äî Sakura AI';
  document.getElementById('toolHeaderIcon').textContent  = tool.icon;
  document.getElementById('toolHeaderTitle').textContent = tool.title;
  document.getElementById('toolHeaderDesc').textContent  = tool.desc;

  loadUsage();

  const user = JSON.parse(localStorage.getItem('sakura_user') || '{}');
  if (user.firstName) document.getElementById('navUserName').textContent = user.firstName;

  // Check if free user from stored data
  if (user.plan === 'free' || !user.plan) {
    isFreeUser = true;
    document.getElementById('freeToolNotice').classList.add('visible');
    updateFreeDailyBar(5); // Default, will be updated after first request
    lockProButtons();
  }
})();

function lockProButtons() {
  var btnImprove    = document.getElementById('btnImprove');
  var btnRegenerate = document.getElementById('btnRegenerate');
  var btnSave       = document.getElementById('btnSave');
  if (btnImprove)    { btnImprove.classList.add('locked');    btnImprove.onclick    = function(){ showUpgradeToast('Improve'); }; }
  if (btnRegenerate) { btnRegenerate.classList.add('locked'); btnRegenerate.onclick = function(){ showUpgradeToast('Regenerate'); }; }
  if (btnSave)       { btnSave.classList.add('locked');       btnSave.onclick       = function(){ showUpgradeToast('Save'); }; }
}

function showUpgradeToast(feature) {
  showToast('üîí ' + feature + ' requires a paid plan. <a href="pricing.html" style="color:white;text-decoration:underline;">Upgrade ‚Üí</a>');
}

function updateFreeDailyBar(remaining) {
  var bar  = document.getElementById('freeDailyBar');
  var dots = document.getElementById('freeDailyDots');
  var text = document.getElementById('freeDailyText');
  if (!bar) return;
  bar.classList.add('visible');
  var limit = 5;
  var used  = limit - remaining;
  dots.innerHTML = '';
  for (var i = 0; i < limit; i++) {
    var dot = document.createElement('div');
    dot.className = 'free-daily-dot' + (i < used ? ' used' : '');
    dots.appendChild(dot);
  }
  if (remaining <= 0) {
    text.innerHTML = '<strong>Daily limit reached.</strong> Resets tomorrow. <a href="pricing.html" style="color:var(--primary-deep);">Upgrade for unlimited</a>';
    document.getElementById('runBtn').disabled = true;
    document.getElementById('askInput').placeholder = 'Daily limit reached ‚Äî upgrade to continue';
  } else {
    text.innerHTML = '<strong>' + remaining + ' of ' + limit + '</strong> free requests remaining today';
  }
}

async function runTool() {
  var prompt = document.getElementById('askInput').value.trim();
  if (!prompt) { showToast('Please type your request first'); return; }
  var params = { prompt: prompt };

  setRunLoading(true);
  showLoading();

  if (IS_DEMO) {
    setRunLoading(false);
    showResult(
      'This tool requires a live backend server.\n\n' +
      'To use this tool: Deploy the backend server and connect it to this frontend.',
      'text', 0, null
    );
    return;
  }

  try {
    var res  = await fetch(API_BASE + '/tools/run', {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'Authorization':'Bearer ' + authToken},
      body: JSON.stringify({toolName: currentTool, params: params})
    });
    var data = await res.json();
    if (!res.ok) {
      if (res.status === 401) { window.location.href = 'auth.html'; return; }
      if (res.status === 429 && data.isFreeLimit) {
        // Free daily limit exceeded
        updateFreeDailyBar(0);
        showResult('‚è∞ You\'ve used all 5 free daily requests. <a href="pricing.html" style="color:var(--primary-deep);font-weight:700;">Upgrade to Pro</a> for unlimited access.', 'error', 0, null);
        return;
      }
      if (res.status === 403 && data.isFreeLimit) {
        // Free plan tool restriction
        showResult('üîí This tool requires a paid plan. <a href="pricing.html" style="color:var(--primary-deep);font-weight:700;">Upgrade to unlock all 35+ tools ‚Üí</a>', 'error', 0, null);
        return;
      }
      if (res.status === 403 && data.code === 'SUBSCRIPTION_REQUIRED') {
        showResult('Active subscription required. <a href="pricing.html" style="color:var(--primary-deep)">Upgrade your plan</a>', 'error', 0, null);
        return;
      }
      if (res.status === 402) {
        showResult('Insufficient credits. <a href="pricing.html" style="color:var(--primary-deep)">Get more credits</a>', 'error', 0, null);
        return;
      }
      throw new Error(data.error || 'Tool execution failed');
    }
    // Update free user state from response
    if (data.isFreeUser) {
      isFreeUser = true;
      if (data.freeDailyRemaining !== null && data.freeDailyRemaining !== undefined) {
        freeDailyRemaining = data.freeDailyRemaining;
        updateFreeDailyBar(freeDailyRemaining);
      }
    }
    if (data.jobId) { pollJobStatus(data.jobId); }
    else { showResult(data.output, data.outputType, data.tokensUsed, data.projectId, data.isTruncated); loadUsage(); }
  } catch(err) {
    showResult(err.message || 'Something went wrong. Please try again.', 'error', 0, null);
  } finally {
    setRunLoading(false);
  }
}

async function pollJobStatus(jobId) {
  var maxAttempts = 60, attempts = 0;
  var poll = async function() {
    attempts++;
    try {
      var res  = await fetch(API_BASE + '/tools/status/' + jobId, {headers:{'Authorization':'Bearer ' + authToken}});
      var data = await res.json();
      if (data.status === 'completed' && data.result) {
        showResult(data.result.output, data.result.outputType, 0, data.result.projectId);
        loadUsage(); setRunLoading(false);
      } else if (data.status === 'failed') {
        showResult(data.error || 'Processing failed.', 'error', 0, null); setRunLoading(false);
      } else if (attempts < maxAttempts) { setTimeout(poll, 2000); }
      else { showResult('Processing timed out. Please try again.', 'error', 0, null); setRunLoading(false); }
    } catch(err) {
      if (attempts < maxAttempts) setTimeout(poll, 3000);
      else { showResult('Connection error during processing.', 'error', 0, null); setRunLoading(false); }
    }
  };
  setTimeout(poll, 1500);
}

function showLoading() {
  document.getElementById('loadingCard').classList.add('visible');
  document.getElementById('resultCard').classList.remove('visible');
  document.getElementById('resultCard').style.display = 'none';
}

function showResult(output, outputType, tokensUsed, projectId, isTruncated) {
  currentOutput    = output;
  currentProjectId = projectId;

  document.getElementById('loadingCard').classList.remove('visible');
  var card = document.getElementById('resultCard');
  card.style.display = 'block';
  card.classList.add('visible');

  var textEl      = document.getElementById('outputText');
  var blurOverlay = document.getElementById('freeBlurOverlay');
  var upgradeBanner = document.getElementById('freeUpgradeBanner');

  // Hide blur overlay by default
  if (blurOverlay) blurOverlay.style.display = 'none';
  if (upgradeBanner) upgradeBanner.classList.remove('visible');

  // Clean truncation marker from display text
  var displayOutput = output ? output.replace('\n\n[SAKURA_FREE_TRUNCATED]', '') : output;

  if (outputType === 'error') {
    textEl.innerHTML = '<div style="color:#DC2626;padding:16px;background:#FEE2E2;border-radius:8px;font-size:14px;line-height:1.7;">‚ö†Ô∏è ' + displayOutput + '</div>';
    textEl.classList.remove('code-output');
  } else if (outputType === 'image') {
    textEl.innerHTML = '<img src="' + displayOutput + '" class="result-image" alt="Generated image" />';
    textEl.classList.remove('code-output');
  } else if (outputType === 'audio') {
    textEl.innerHTML = '<p style="margin-bottom:12px;color:var(--gray);font-size:13px;">Your audio is ready:</p><audio controls class="result-audio"><source src="' + displayOutput + '" type="audio/mpeg"></audio>';
    textEl.classList.remove('code-output');
  } else if (outputType === 'code') {
    textEl.textContent = displayOutput;
    textEl.classList.add('code-output');
  } else {
    textEl.textContent = displayOutput;
    textEl.classList.remove('code-output');
  }

  // Show blur overlay if output was truncated (free user)
  if (isTruncated && blurOverlay) {
    blurOverlay.style.display = 'flex';
    document.getElementById('outputWrap').classList.add('free-blur-wrap');
  }

  // Show upgrade banner for free users after any result
  if (isFreeUser && outputType !== 'error' && upgradeBanner) {
    upgradeBanner.classList.add('visible');
  }

  var meta = document.getElementById('outputMeta');
  meta.innerHTML = '';
  if (tokensUsed > 0) meta.innerHTML += '<span class="result-meta-item"><i class="fas fa-coins"></i> ' + tokensUsed.toLocaleString() + ' tokens used</span>';
  if (projectId)      meta.innerHTML += '<span class="result-meta-item"><i class="fas fa-save"></i> Auto-saved to projects</span>';
  if (isFreeUser)     meta.innerHTML += '<span class="result-meta-item" style="color:var(--primary-deep);"><i class="fas fa-star"></i> Free plan result</span>';
  meta.innerHTML += '<span class="result-meta-item"><i class="fas fa-clock"></i> ' + new Date().toLocaleTimeString() + '</span>';
}

function setRunLoading(loading) {
  var btn    = document.getElementById('runBtn');
  var text   = document.getElementById('runBtnText');
  var loader = document.getElementById('runBtnLoader');
  if (!btn) return;
  btn.disabled         = loading;
  text.style.display   = loading ? 'none' : 'flex';
  loader.style.display = loading ? 'flex' : 'none';
}

function copyOutput() {
  if (!currentOutput) return;
  navigator.clipboard.writeText(currentOutput).then(function() { showToast('Copied to clipboard!'); });
}

async function saveProject() {
  if (!currentOutput || !currentProjectId) { showToast('No output to save'); return; }
  showToast('Already saved to your projects!');
}

async function regenerate() {
  if (!currentProjectId) { runTool(); return; }
  setRunLoading(true); showLoading();
  try {
    var res  = await fetch(API_BASE + '/tools/regenerate', {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer ' + authToken},
      body: JSON.stringify({projectId: currentProjectId})
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error);
    if (data.jobId) pollJobStatus(data.jobId);
    else showResult(data.output, data.outputType, 0, data.projectId);
  } catch(err) {
    showResult(err.message || 'Regeneration failed.', 'error', 0, null);
  } finally { setRunLoading(false); }
}

function openImproveModal() {
  if (!currentOutput) { showToast('Generate output first'); return; }
  document.getElementById('improveModal').classList.add('open');
}

async function submitImprove() {
  var instruction = document.getElementById('improveInstruction').value.trim();
  if (!instruction) { showToast('Please enter improvement instructions'); return; }
  document.getElementById('improveModal').classList.remove('open');
  setRunLoading(true); showLoading();
  try {
    var res  = await fetch(API_BASE + '/tools/improve', {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer ' + authToken},
      body: JSON.stringify({projectId: currentProjectId, instruction: instruction})
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error);
    showResult(data.output, 'text', data.tokensUsed, currentProjectId);
  } catch(err) {
    showResult(err.message || 'Improvement failed.', 'error', 0, null);
  } finally { setRunLoading(false); }
}

async function loadUsage() {
  if (IS_DEMO) {
    document.getElementById('usageText').textContent = 'Backend required';
    document.getElementById('usageBarFill').style.width = '0%';
    return;
  }
  try {
    var res  = await fetch(API_BASE + '/tools/usage', {headers:{'Authorization':'Bearer ' + authToken}});
    var data = await res.json();
    if (!res.ok) return;
    document.getElementById('usageText').textContent = data.tokens.used.toLocaleString() + ' / ' + data.tokens.limit.toLocaleString() + ' tokens';
    document.getElementById('usageBarFill').style.width = data.tokens.percentage + '%';
    if (data.tokens.percentage > 90) document.getElementById('usageBarFill').style.background = '#EF4444';

    // Update free user state
    if (data.isFreeUser) {
      isFreeUser = true;
      document.getElementById('freeToolNotice').classList.add('visible');
      lockProButtons();
      if (data.freeDaily && data.freeDaily.remaining !== null) {
        updateFreeDailyBar(data.freeDaily.remaining);
      }
    }
  } catch(e) {}
}

document.getElementById('improveModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('open');
});
</script>
<script src="sakura-assistant.js"></script>
</body>
</html>
